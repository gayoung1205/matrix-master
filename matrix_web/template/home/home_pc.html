{% load static %}
{% load filter_tags %}
{% csrf_token %}

<link rel="stylesheet" href="{% static 'css/profile_modal.css' %}">

<!-- 레이아웃 편집 버튼 -->
<button class="btn btn-primary layout-toggle-btn" id="layoutToggleBtn" title="레이아웃 편집">
    <i class="fas fa-grip-horizontal"></i>
</button>

<!-- 레이아웃 편집 제어 패널 -->
<div class="layout-controls hidden" id="layoutControls">
    <div class="layout-controls-title">
        <h6><i class="fas fa-pen"></i> 레이아웃 편집</h6>
        <p class="layout-controls-subtitle">- 모니터 배치를 자유롭게 조정하세요.</p>
        <p class="layout-controls-subtitle">- 이름을 자유롭게 수정하세요.</p>
    </div>
    <div class="text-center">
        <button class="btn btn-save btn-sm" id="saveLayoutBtn">
            <i class="fas fa-save"></i> 저장
        </button>
        <button class="btn btn-reset btn-sm" id="resetLayoutBtn">
            <i class="fas fa-undo"></i> 초기화
        </button>
        <button class="btn btn-close btn-sm" id="closeLayoutBtn">
            <i class="fas fa-times"></i> 닫기
        </button>
    </div>
    <hr style="margin: 15px 0;">
    <h6><i class="fas fa-eye-slash"></i> 숨겨진 모니터</h6>
    <div id="hiddenMonitors" style="max-height: 150px; overflow-y: auto;">
        <small class="text-muted">숨겨진 모니터가 없습니다.</small>
    </div>
</div>

<!-- 이름 수정 모달 -->
<div class="modal fade" id="updateNamesModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">이름 수정</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="updateNamesForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="modal-monitor-name">모니터 이름</label>
                        <input type="text" class="form-control" id="modal-monitor-name" placeholder="모니터 이름을 입력하세요">
                    </div>
                    <div class="form-group">
                        <label for="modal-device-name">디바이스 이름</label>
                        <input type="text" class="form-control" id="modal-device-name" placeholder="디바이스 이름을 입력하세요">
                    </div>
                    <input type="hidden" id="modal-position">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="container-fluid matrix-list" style="overflow-y:auto; max-height:calc(100vh - 80px);">
    <div class="row">
        <div class="col-10">

            <!-- 메인 매트릭스 (16포트) -->
            {% if main %}
                {% for m in main %}
                    <div class="card matrix-card main" data-matrix-id="{{ m.id }}">
                        <div class="card-body">
                            <h5 class="card-title text-center">{{ m.name }}</h5>

                            <!-- 첫 번째 행 (1-8) -->
                            <div class="sortable-row" data-row="1">
                                {% for i in 1|range_tag:9 %}
                                    <div class="monitor-item"
                                         data-position="{{ i }}"
                                         data-matrix="{{ m.id }}"
                                         data-row="1"
                                         data-col="{{ i }}"
                                         draggable="false">

                                        <!-- 모니터 컨트롤 버튼들 -->
                                        <div class="monitor-controls">
                                            <button class="btn btn-outline-secondary btn-toggle-visibility"
                                                    data-position="{{ i }}"
                                                    data-matrix="{{ m.id }}"
                                                    title="숨기기">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-primary btn-edit-names"
                                                    data-toggle="modal"
                                                    data-target="#updateNamesModal"
                                                    data-matrix="{{ m.id }}"
                                                    data-position="{{ i }}"
                                                    title="이름 수정">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>

                                        <div class="control">
                                            <p class="monitor-label">{{ m|monitor_name:i|default:"모니터"|add:" "|add:i }}</p>
                                            <img src="{% static 'img/monitor.png' %}" alt="Monitor">
                                            <div class="form-group mt-2">
                                                <select class="form-control form-control-sm monitor-select"
                                                        name="input_select"
                                                        id="input_select-{{ i|stringformat:"02d" }}-{{ m.id }}">
                                                    {% for j in 0|range_tag:17 %}
                                                        <option {% if j == 0 %}selected{% endif %}
                                                                {% if m|option_selected:i == j %}selected{% endif %}
                                                                value="{{ j|stringformat:"02d" }}">
                                                            {% if j == 0 %}-{% else %}{{ m|device_name:j|default:"PC"|add:j }}{% endif %}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- 두 번째 행 (9-16) -->
                            <div class="sortable-row" data-row="2">
                                {% for i in 9|range_tag:17 %}
                                    <div class="monitor-item"
                                         data-position="{{ i }}"
                                         data-matrix="{{ m.id }}"
                                         data-row="2"
                                         data-col="{{ i|add:"-8" }}"
                                         draggable="false">

                                        <!-- 모니터 컨트롤 버튼들 -->
                                        <div class="monitor-controls">
                                            <button class="btn btn-outline-secondary btn-toggle-visibility"
                                                    data-position="{{ i }}"
                                                    data-matrix="{{ m.id }}"
                                                    title="숨기기">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-primary btn-edit-names"
                                                    data-toggle="modal"
                                                    data-target="#updateNamesModal"
                                                    data-matrix="{{ m.id }}"
                                                    data-position="{{ i }}"
                                                    title="이름 수정">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>

                                        <div class="control">
                                            <p class="monitor-label">{{ m|monitor_name:i|default:"모니터"|add:" "|add:i }}</p>
                                            <img src="{% static 'img/monitor.png' %}" alt="Monitor">
                                            <div class="form-group mt-2">
                                                <select class="form-control form-control-sm monitor-select"
                                                        name="input_select"
                                                        id="input_select-{{ i|stringformat:"02d" }}-{{ m.id }}">
                                                    {% for j in 0|range_tag:17 %}
                                                        <option {% if j == 0 %}selected{% endif %}
                                                                {% if m|option_selected:i == j %}selected{% endif %}
                                                                value="{{ j|stringformat:"02d" }}">
                                                            {% if j == 0 %}-{% else %}{{ m|device_name:j|default:"PC"|add:j }}{% endif %}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- 터치 PC (KVM) 카드 -->
                    <div class="card matrix-card main">
                        <div class="card-body">
                            <h5 class="card-title">터치 PC</h5>
                            {% for i in 1|range_tag:33 %}
                                {% if i|remainder:8 == 1 %}
                                    <div class="row align-items-center">
                                {% endif %}
                            <div class="col-1_5 mb-2">
                                <button class="btn btn-outline-primary w-100 kvm"
                                        name="kvm_button"
                                        value="{{ m.id }}-{{ i }}">
                                    {{ connect_list|kvm_index:i }}
                                </button>
                            </div>
                            {% if i|remainder:8 == 0 or i == 32 %}
                                </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- 서브 매트릭스들 (16포트) -->
            {% if matrix %}
                {% for mat in matrix %}
                    <div class="card matrix-card" data-matrix-id="{{ mat.id }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ mat.name }}</h5>

                            <!-- 첫 번째 행 (1-8) -->
                            <div class="sortable-row" data-row="1">
                                {% for i in 1|range_tag:9 %}
                                    <div class="monitor-item"
                                         data-position="{{ i }}"
                                         data-matrix="{{ mat.id }}"
                                         data-row="1"
                                         data-col="{{ i }}"
                                         draggable="false">

                                        <!-- 모니터 컨트롤 버튼들 -->
                                        <div class="monitor-controls">
                                            <button class="btn btn-outline-secondary btn-toggle-visibility"
                                                    data-position="{{ i }}"
                                                    data-matrix="{{ mat.id }}"
                                                    title="숨기기">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-primary btn-edit-names"
                                                    data-toggle="modal"
                                                    data-target="#updateNamesModal"
                                                    data-matrix="{{ mat.id }}"
                                                    data-position="{{ i }}"
                                                    title="이름 수정">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>

                                        <div class="control">
                                            <p class="monitor-label">{{ mat|monitor_name:i|default:"모니터"|add:" "|add:i }}</p>
                                            <img src="{% static 'img/monitor.png' %}" alt="Monitor">
                                            <div class="form-group mt-2">
                                                <select class="form-control form-control-sm monitor-select"
                                                        name="input_select"
                                                        id="input_select-{{ i|stringformat:"02d" }}-{{ mat.id }}">
                                                    {% for j in 0|range_tag:17 %}
                                                        <option {% if j == 0 %}selected{% endif %}
                                                                {% if mat|option_selected:i == j %}selected{% endif %}
                                                                value="{{ j|stringformat:"02d" }}">
                                                            {% if j == 0 %}-{% else %}{{ mat|device_name:j|default:"PC"|add:j }}{% endif %}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- 두 번째 행 (9-16) -->
                            <div class="sortable-row" data-row="2">
                                {% for i in 9|range_tag:17 %}
                                    <div class="monitor-item"
                                         data-position="{{ i }}"
                                         data-matrix="{{ mat.id }}"
                                         data-row="2"
                                         data-col="{{ i|add:"-8" }}"
                                         draggable="false">

                                        <!-- 모니터 컨트롤 버튼들 -->
                                        <div class="monitor-controls">
                                            <button class="btn btn-outline-secondary btn-toggle-visibility"
                                                    data-position="{{ i }}"
                                                    data-matrix="{{ mat.id }}"
                                                    title="숨기기">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-primary btn-edit-names"
                                                    data-toggle="modal"
                                                    data-target="#updateNamesModal"
                                                    data-matrix="{{ mat.id }}"
                                                    data-position="{{ i }}"
                                                    title="이름 수정">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>

                                        <div class="control">
                                            <p class="monitor-label">{{ mat|monitor_name:i|default:"모니터"|add:" "|add:i }}</p>
                                            <img src="{% static 'img/monitor.png' %}" alt="Monitor">
                                            <div class="form-group mt-2">
                                                <select class="form-control form-control-sm monitor-select"
                                                        name="input_select"
                                                        id="input_select-{{ i|stringformat:"02d" }}-{{ mat.id }}">
                                                    {% for j in 0|range_tag:17 %}
                                                        <option {% if j == 0 %}selected{% endif %}
                                                                {% if mat|option_selected:i == j %}selected{% endif %}
                                                                value="{{ j|stringformat:"02d" }}">
                                                            {% if j == 0 %}-{% else %}{{ mat|device_name:j|default:"PC"|add:j }}{% endif %}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="col-2 profile-column">
            <div class="card profile-card">
                <div class="card-header">
                    <h5 class="card-title">즐겨찾기</h5>
                </div>
                {% if profile %}
                    <div class="card-body">
                        <ul class="fav fav--glass">
                            {% for pro in profile %}
                                <li class="list-group-item">
                                    <button class="fav-btn btn btn-outline-primary"
                                            name="profile_button"
                                            value="{{ pro.id }}">{{ pro.name }}</button>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>

