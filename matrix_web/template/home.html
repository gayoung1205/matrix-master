{% extends 'base.html' %}
{% load static %} {% load filter_tags %}
{% block extra_css %}
<!-- Home í˜ì´ì§€ ì „ìš© CSS -->
<link rel="stylesheet" type="text/css" href="{% static 'css/home.css' %}?v=1" />
{% endblock extra_css %}
{% block content %}


<button class="btn btn-primary layout-toggle-btn" id="layoutToggleBtn" title="ë ˆì´ì•„ì›ƒ í¸ì§‘">
    <i class="fas fa-grip-horizontal"></i>
</button>

<div class="layout-controls hidden" id="layoutControls">
    <div class="layout-controls-title">
        <h6><i class="fas fa-pen"></i> ë ˆì´ì•„ì›ƒ í¸ì§‘</h6>
        <p class="layout-controls-subtitle">- ëª¨ë‹ˆí„° ë°°ì¹˜ë¥¼ ììœ ë¡­ê²Œ ì¡°ì •í•˜ì„¸ìš”.</p>
        <p class="layout-controls-subtitle">- ì´ë¦„ì„ ììœ ë¡­ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.</p>
    </div>
    <div class="text-center">
        <button class="btn btn-save btn-sm" id="saveLayoutBtn">
            <i class="fas fa-save"></i> ì €ì¥
        </button>
        <button class="btn btn-reset btn-sm" id="resetLayoutBtn">
            <i class="fas fa-undo"></i> ì´ˆê¸°í™”
        </button>
        <button class="btn btn-close btn-sm" id="closeLayoutBtn">
            <i class="fas fa-times"></i> ë‹«ê¸°
        </button>
    </div>
    <hr style="margin: 15px 0;">
    <h6><i class="fas fa-eye-slash"></i> ìˆ¨ê²¨ì§„ ëª¨ë‹ˆí„°</h6>
    <div id="hiddenMonitors" style="max-height: 150px; overflow-y: auto;">
        <small class="text-muted">ìˆ¨ê²¨ì§„ ëª¨ë‹ˆí„°ê°€ ì—†ìŠµë‹ˆë‹¤.</small>
    </div>
</div>

<div class="container-fluid matrix-list" style="overflow-y:auto; max-height:calc(100vh - 80px);">
    <div class="row">
        <div class="col-10">

            <!-- ë©”ì¸ ë§¤íŠ¸ë¦­ìŠ¤ (16í¬íŠ¸) -->
            {% if main %}
                {% for m in main %}
                    <div class="card matrix-card main" data-matrix-id="{{ m.id }}">
                        <div class="card-body">
                            <h5 class="card-title text-center">{{ m.name }}</h5>

                            <!-- ì²« ë²ˆì§¸ í–‰ (1-8) -->
                            <div class="sortable-row" data-row="1" style="position: relative;">
                                {% for i in 1|range_tag:9 %}
                                    <div class="monitor-item"
                                         data-position="{{ i }}"
                                         data-matrix="{{ m.id }}"
                                         data-row="1"
                                         data-col="{{ i }}"
                                         draggable="false">


                                        <div class="monitor-controls">
                                            <button class="btn btn-outline-secondary btn-toggle-visibility"
                                                    title="ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°"
                                                    data-position="{{ i }}"
                                                    data-matrix="{{ m.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary btn-edit-names"
                                                    title="ì´ë¦„ ìˆ˜ì •"
                                                    data-position="{{ i }}"
                                                    data-matrix="{{ m.id }}"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#updateNamesModal"
                                                    style="display: none;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>

                                        <div class="control">
                                            <img src="{% static 'img/icon1.png' %}" />
                                            <p class="monitor-label">{{ m|monitor_name:i }}</p>
                                        </div>
                                        <div class="form-group">
                                            <select class="form-control form-control-sm monitor-select"
                                                    name="input_select"
                                                    id="input_select-{{ i|stringformat:"02d" }}-{{ m.id }}">
                                                {% for j in 1|range_tag:17 %}
                                                    <option value="{{ j|stringformat:"02d" }}"
                                                            {% if m|option_selected:i == j %}selected{% endif %}>
                                                        {{ m|device_name:j }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- ë‘ ë²ˆì§¸ í–‰ (9-16) -->
                            <div class="sortable-row" data-row="2" style="position: relative;">
                                {% for i in 9|range_tag:17 %}
                                    <div class="monitor-item"
                                         data-position="{{ i }}"
                                         data-matrix="{{ m.id }}"
                                         data-row="2"
                                         data-col="{{ i|add:'-8' }}"
                                         draggable="false">

                                        <div class="monitor-controls">
                                            <button class="btn btn-outline-secondary btn-toggle-visibility"
                                                    title="ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°"
                                                    data-position="{{ i }}"
                                                    data-matrix="{{ m.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary btn-edit-names"
                                                    title="ì´ë¦„ ìˆ˜ì •"
                                                    data-position="{{ i }}"
                                                    data-matrix="{{ m.id }}"
                                                    data-toggle="modal"
                                                    data-target="#updateNamesModal"
                                                    style="display: none;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>

                                        <div class="control">
                                            <img src="{% static 'img/icon1.png' %}" />
                                            <p class="monitor-label">{{ m|monitor_name:i }}</p>
                                        </div>
                                        <div class="form-group">
                                            <select class="form-control form-control-sm monitor-select"
                                                    name="input_select"
                                                    id="input_select-{{ i|stringformat:"02d" }}-{{ m.id }}">
                                                {% for j in 1|range_tag:17 %}
                                                    <option value="{{ j|stringformat:"02d" }}"
                                                            {% if m|option_selected:i == j %}selected{% endif %}>
                                                        {{ m|device_name:j }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- í„°ì¹˜ PC (KVM) ì¹´ë“œ -->
                    <div class="card matrix-card main">
                        <div class="card-body">
                            <h5 class="card-title">í„°ì¹˜ PC</h5>
                            {% for i in 1|range_tag:33 %}
                                {% if i|remainder:8 == 1 %}
                                    <div class="row align-items-center">
                                {% endif %}
                            <div class="col-1_5 mb-2">
                                <button class="btn btn-outline-primary w-100 kvm"
                                        name="kvm_button"
                                        value="{{ m.id }}-{{ i }}">
                                    {{ connect_list|kvm_index:i }}
                                </button>
                            </div>
                            {% if i|remainder:8 == 0 or i == 32 %}
                                </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- ì„œë¸Œ ë§¤íŠ¸ë¦­ìŠ¤ë“¤ (16í¬íŠ¸) -->
            {% if matrix %}
                {% for mat in matrix %}
                    <div class="card matrix-card" data-matrix-id="{{ mat.id }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ mat.name }}</h5>

                            <!-- ì²« ë²ˆì§¸ í–‰ (1-8) -->
                            <div class="sortable-row" data-row="1">
                                {% for i in 1|range_tag:9 %}
                                    <div class="monitor-item"
                                         data-position="{{ i }}"
                                         data-matrix="{{ mat.id }}"
                                         data-row="1"
                                         data-col="{{ i }}"
                                         draggable="false">

                                        <div class="monitor-controls">
                                            <button class="btn btn-outline-secondary btn-toggle-visibility"
                                                    title="ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°"
                                                    data-position="{{ i }}"
                                                    data-matrix="{{ mat.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary btn-edit-names"
                                                    title="ì´ë¦„ ìˆ˜ì •"
                                                    data-position="{{ i }}"
                                                    data-matrix="{{ mat.id }}"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#updateNamesModal"
                                                    style="display: none;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>

                                        <div class="control">
                                            <img src="{% static 'img/icon1.png' %}" />
                                        </div>
                                        <button class="btn btn-outline-gradient kvm"
                                                name="kvm_button"
                                                value="{{ mat.id }}-{{ i }}">
                                            {{ mat|profile_monitor_name:i }}
                                        </button>
                                        <div class="form-group">
                                            <select class="form-control form-control-sm monitor-select"
                                                    name="input_select"
                                                    id="input_select-{{ i|stringformat:"02d" }}-{{ mat.id }}">
                                                {% for j in 1|range_tag:17 %}
                                                    <option value="{{ j|stringformat:"02d" }}"
                                                            {% if mat|option_selected:i == j %}selected{% endif %}>
                                                        {{ mat|device_name:j }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- ë‘ ë²ˆì§¸ í–‰ (9-16) -->
                            <div class="sortable-row" data-row="2">
                                {% for i in 9|range_tag:17 %}
                                    <div class="monitor-item"
                                         data-position="{{ i }}"
                                         data-matrix="{{ mat.id }}"
                                         data-row="2"
                                         data-col="{{ i|add:'-8' }}"
                                         draggable="false">

                                        <div class="monitor-controls">
                                            <button class="btn btn-outline-secondary btn-toggle-visibility"
                                                    title="ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°"
                                                    data-position="{{ i }}"
                                                    data-matrix="{{ mat.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary btn-edit-names"
                                                    title="ì´ë¦„ ìˆ˜ì •"
                                                    data-position="{{ i }}"
                                                    data-matrix="{{ mat.id }}"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#updateNamesModal"
                                                    style="display: none;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>

                                        <div class="control">
                                            <img src="{% static 'img/icon1.png' %}" />
                                        </div>
                                        <button class="btn btn-outline-gradient kvm"
                                                name="kvm_button"
                                                value="{{ mat.id }}-{{ i }}">
                                            {{ mat|profile_monitor_name:i }}
                                        </button>
                                        <div class="form-group">
                                            <select class="form-control form-control-sm monitor-select"
                                                    name="input_select"
                                                    id="input_select-{{ i|stringformat:"02d" }}-{{ mat.id }}">
                                                {% for j in 1|range_tag:17 %}
                                                    <option value="{{ j|stringformat:"02d" }}"
                                                            {% if mat|option_selected:i == j %}selected{% endif %}>
                                                        {{ mat|device_name:j }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                        </div>
                    </div>
                {% endfor %}
            {% endif %}

            <div id="toggleSection" class="mt-3" style="display: none;">
                <div class="alert alert-info w-100">
                    <h5>ê·¸ë£¹ ì„¤ì •</h5>
                    <div class="row">
                        {% for i in 1|range_tag:17 %}
                        <div class="col-1-5 mb-3">
                            <div class="card text-center channel-box" data-chan="{{ i }}">
                                <div class="card-header">CH{{ i }}</div>
                                <div class="card-body p-3">
                                    <h5>In {{ i }}</h5>
                                    <button class="btn btn-sm btn-danger unselect-btn">âŒ</button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3 text-center">
                        <button id="groupBtn" class="btn btn-warning">ğŸ”— Group</button>
                        <button id="ungroupBtn" class="btn btn-warning">âŒ Un group</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-2 profile-column">
            <div class="card profile-card">
                {% if profile %}
                    <div class="card-header">
                        <h5 class="card-title">ì¦ê²¨ì°¾ê¸°</h5>
                    </div>
                    <div>
                        <div data-simplebar class="card-body">
                            <ul id="favoritesList" class="fav fav--glass">
                                {% for pro in profile %}
                                    <li class="list-group-item">
                                        <button class="fav-btn" name="profile_button" value="{{ pro.id }}">
                                            {{ pro.name }}
                                        </button>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>


<div class="modal fade" id="profile-update" tabindex="-1" role="dialog" aria-labelledby="profile-update-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md" role="document">
        <div class="modal-content shadow-lg border-0 rounded-3">

            <div class="modal-header bg-primary text-white rounded-top">
                <h5 class="modal-title font-weight-bold" id="profile-update-modal-title">ì¦ê²¨ì°¾ê¸° ìˆ˜ì •</h5>
                <button type="button" class="close text-white" onclick="forceCloseModal()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <form method="post" action="{% url 'profile_detail' %}" id="profile-update-form">
                {% csrf_token %}
                <input type="hidden" name="_method" value="put" />
                <input type="hidden" id="update-id" name="id" />
                <input type="hidden" id="update-mat-id-list" name="mat_id_list" />
                <input type="hidden" id="update-input-1" name="input_a" />
                <input type="hidden" id="update-input-2" name="input_b" />
                <input type="hidden" id="update-input-3" name="input_c" />
                <input type="hidden" id="update-input-4" name="input_d" />
                <input type="hidden" id="update-input-5" name="input_e" />
                <input type="hidden" id="update-input-6" name="input_f" />
                <input type="hidden" id="update-input-7" name="input_g" />
                <input type="hidden" id="update-input-8" name="input_h" />

                <input type="hidden" id="update-input-9" name="input_i" />
                <input type="hidden" id="update-input-10" name="input_j" />
                <input type="hidden" id="update-input-11" name="input_k" />
                <input type="hidden" id="update-input-12" name="input_l" />
                <input type="hidden" id="update-input-13" name="input_m" />
                <input type="hidden" id="update-input-14" name="input_n" />
                <input type="hidden" id="update-input-15" name="input_o" />
                <input type="hidden" id="update-input-16" name="input_p" />
                <input type="hidden" id="update-input-kvm" name="input_kvm" />

                <div class="modal-body px-4 py-3">
                    <div class="form-group mb-4">
                        <label for="input-name-update" class="font-weight-bold">ì¦ê²¨ì°¾ê¸°ëª…</label>
                        <input hidden="hidden" />
                        <input
                                type="text"
                                class="form-control form-control-lg"
                                id="input-name-update"
                                name="name"
                                placeholder="ì˜ˆ: ë¹µë°©êµ¬"
                                required
                        />
                        <div id="update-name-feedback" class="invalid-feedback">ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                    </div>

                    {% if main_mat %}
                    {% for mat in main_mat %}
                    <h5 class="mt-4 font-weight-bold">{{mat.name}}</h5>
                    <input type="hidden" class="update-system-id" value="{{mat.id}}" />

                    <!-- ì²« ë²ˆì§¸ í–‰ (1-8) -->
                    <div class="form-row">
                        {% for i in 1|range_tag:9 %}
                        <div class="form-group col-md-3 mb-3">
                            <label for="update-input-select-{{mat.id}}-{{i}}">{{ mat|monitor_name:i }}</label>
                            <select id="update-input-select-{{mat.id}}-{{i}}" class="form-control form-control-sm update-select-{{i}}">
                                {% for j in 0|range_tag:17 %}
                                <option {% if j == 0 %}selected{% endif %} value="{{ j|stringformat:"02d" }}">
                                    {% if j == 0 %}-{% else %}{{ mat|device_name:j }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- ë‘ ë²ˆì§¸ í–‰ (9-16) -->
                    <div class="form-row">
                        {% for i in 9|range_tag:17 %}
                        <div class="form-group col-md-3 mb-3">
                            <label for="update-input-select-{{mat.id}}-{{i}}">{{ mat|monitor_name:i }}</label>
                            <select id="update-input-select-{{mat.id}}-{{i}}" class="form-control form-control-sm update-select-{{i}}">
                                {% for j in 0|range_tag:17 %}
                                <option {% if j == 0 %}selected{% endif %} value="{{ j|stringformat:"02d" }}">
                                    {% if j == 0 %}-{% else %}{{ mat|device_name:j }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- KVM ì„¤ì • -->
                    <div class="form-row">
                        <div class="form-group col-md-3 mb-3">
                            <label for="update-main-input-kvm">USB</label>
                            <select id="update-main-input-kvm" class="form-control form-control-sm update-input-kvm">
                                {% for j in 0|range_tag:33 %}
                                <option {% if j == 0 %}selected{% endif %} value="{{ j|stringformat:"02d" }}">{{ connect_list|kvm_index:j }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}

                    <!-- ì„œë¸Œ ë§¤íŠ¸ë¦­ìŠ¤ ì„¤ì • -->
                    {% if sub_mat %}
                    {% for mat in sub_mat %}
                    <h5 class="mt-4 font-weight-bold">{{ mat.name }}</h5>
                    <input type="hidden" class="update-system-id" value="{{ mat.id }}" />

                    <!-- ì²« ë²ˆì§¸ í–‰ (1-8) -->
                    <div class="form-row">
                        {% for i in 1|range_tag:9 %}
                            <div class="form-group col-md-3 mb-3">
                                <label for="update-input-select-{{ mat.id }}-{{ i }}">{{ mat|profile_monitor_name:i }}</label>
                                <select id="update-input-select-{{ mat.id }}-{{ i }}" class="form-control form-control-sm update-select-{{ i }}">
                                    {% for j in 0|range_tag:17 %}
                                        <option {% if j == 0 %}selected{% endif %} value="{{ j|stringformat:"02d" }}">
                                            {% if j == 0 %}-{% else %}{{ mat|device_name:j }}{% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- ë‘ ë²ˆì§¸ í–‰ (9-16) -->
                    <div class="form-row">
                        {% for i in 9|range_tag:17 %}
                            <div class="form-group col-md-3 mb-3">
                                <label for="update-input-select-{{ mat.id }}-{{ i }}">{{ mat|profile_monitor_name:i }}</label>
                                <select id="update-input-select-{{ mat.id }}-{{ i }}" class="form-control form-control-sm update-select-{{ i }}">
                                    {% for j in 0|range_tag:17 %}
                                        <option {% if j == 0 %}selected{% endif %} value="{{ j|stringformat:"02d" }}">
                                            {% if j == 0 %}-{% else %}{{ mat|device_name:j }}{% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- KVM ì„¤ì • -->
                    <div class="form-row">
                        <div class="form-group col-md-3 mb-3">
                            <label for="update-sub-input-kvm-{{ mat.main_connect }}">USB</label>
                            <select id="update-sub-input-kvm-{{ mat.main_connect }}" class="form-control form-control-sm update-input-kvm">
                                {% for j in 0|range_tag:17 %}
                                    <option {% if j == 0 %}selected{% endif %} value="{{ j|stringformat:"02d" }}">{{ mat|device_name:j }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>

                <div class="modal-footer bg-light border-top-0 rounded-bottom px-4 py-3">
                    <button type="button" class="btn btn-modal-secondary" onclick="forceCloseModal()">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-modal-primary" onClick="profileUpdate()">ìˆ˜ì •</button>
                </div>
            </form>

        </div>
    </div>
</div>

<div class="modal fade" id="updateNamesModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="updateNamesForm" method="post">
            {% csrf_token %}
            <input type="hidden" id="modal-position" name="position" value="">
            <input type="hidden" id="modal-matrix-id" name="matrix_id" value="">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ëª¨ë‹ˆí„°Â·ë””ë°”ì´ìŠ¤ ì´ë¦„ ìˆ˜ì •</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ëª¨ë‹ˆí„° ì´ë¦„</label>
                        <input type="text" class="form-control" id="modal-monitor-name"
                               name="monitor_name" value="">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ë””ë°”ì´ìŠ¤ ì´ë¦„</label>
                        <input type="text" class="form-control" id="modal-device-name"
                               name="device_name" value="">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-modal-primary">ì €ì¥</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% include 'modal/error_modal.html' %}

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-backdrop="static" data-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content" style="background-color: rgba(255, 255, 255, 0); border: none">
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block javascript %}

<script src="{% static 'js/home.js' %}"></script>

<script>
    // 8í¬íŠ¸ì—ì„œ ê°€ì ¸ì˜¨ ë ˆì´ì•„ì›ƒ í¸ì§‘ ê¸°ëŠ¥ ë³€ìˆ˜ë“¤
    let isLayoutMode = false;
    let draggedElement = null;

    // ë ˆì´ì•„ì›ƒ ëª¨ë“œ í† ê¸€
    $(document).on('click', '#layoutToggleBtn', function() {
        console.log('Layout toggle clicked, current mode:', isLayoutMode);
        isLayoutMode = !isLayoutMode;
        if (isLayoutMode) {
            enterLayoutMode();
        } else {
            exitLayoutMode();
        }
    });

    // ë ˆì´ì•„ì›ƒ ëª¨ë“œ ì§„ì…
    function enterLayoutMode() {
        console.log('Entering layout mode');
        const $btn = $('#layoutToggleBtn');
        const $controls = $('#layoutControls');

        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
        $btn.addClass('editing');
        $btn.html('<i class="fas fa-stop"></i>');
        $btn.attr('title', 'í¸ì§‘ ì¤‘ì§€');

        // ì œì–´ íŒ¨ë„ í‘œì‹œ
        $controls.removeClass('hidden');
        setTimeout(() => $controls.addClass('show'), 50);

        // í¸ì§‘ ëª¨ë“œ í™œì„±í™”
        $('.matrix-card').addClass('editing-mode');

        // ì´ë¦„ ìˆ˜ì • ë²„íŠ¼ í‘œì‹œ
        $('.btn-edit-names').show();

        // ë“œë˜ê·¸ ì´ë²¤íŠ¸ í™œì„±í™”
        enableDragAndDrop();

        // ê¸°ì¡´ ì œì–´ ë¹„í™œì„±í™”
        $('select[name=input_select]').prop('disabled', true);
        $('button[name=kvm_button]').prop('disabled', true);

        updateHiddenMonitorsList();
        showEditingToast();
    }

    // ë ˆì´ì•„ì›ƒ ëª¨ë“œ ì¢…ë£Œ
    function exitLayoutMode() {
        console.log('Exiting layout mode');
        const $btn = $('#layoutToggleBtn');
        const $controls = $('#layoutControls');

        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³µêµ¬
        $btn.removeClass('editing');
        $btn.html('<i class="fas fa-grip-horizontal"></i>');
        $btn.attr('title', 'ë ˆì´ì•„ì›ƒ í¸ì§‘');

        // ì œì–´ íŒ¨ë„ ìˆ¨ê¹€
        $controls.removeClass('show');
        setTimeout(() => $controls.addClass('hidden'), 300);

        // í¸ì§‘ ëª¨ë“œ ë¹„í™œì„±í™”
        $('.matrix-card').removeClass('editing-mode');

        // ì´ë¦„ ìˆ˜ì • ë²„íŠ¼ ìˆ¨ê¹€
        $('.btn-edit-names').hide();

        // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¹„í™œì„±í™”
        disableDragAndDrop();

        // ê¸°ì¡´ ì œì–´ í™œì„±í™”
        $('select[name=input_select]').prop('disabled', false);
        $('button[name=kvm_button]').prop('disabled', false);
    }

    // ë“œë˜ê·¸ì•¤ë“œë¡­ í™œì„±í™”
    function enableDragAndDrop() {
        console.log('Enabling drag and drop');
        $('.monitor-item').attr('draggable', true);

        $('.monitor-item').off('dragstart dragend dragover');
        $('.sortable-row').off('dragover dragleave drop');

        $('.monitor-item').on('dragstart', function(e) {
            draggedElement = this;
            $(this).addClass('dragging');
            e.originalEvent.dataTransfer.effectAllowed = 'move';
            e.originalEvent.dataTransfer.setData('text/html', this.innerHTML);
            console.log('Drag started:', $(this).data('position'));
        });

        $('.monitor-item').on('dragend', function(e) {
            $(this).removeClass('dragging');
            $('.drag-over').removeClass('drag-over');
            $('.drag-over-element').removeClass('drag-over-element');
            draggedElement = null;
            console.log('Drag ended');
        });

        $('.monitor-item').on('dragover', function(e) {
            if (this === draggedElement) return;

            e.preventDefault();
            e.stopPropagation();

            const draggingItem = $(draggedElement);
            const targetItem = $(this);
            const targetRow = targetItem.closest('.sortable-row');

            // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì— ë”°ë¼ ì•/ë’¤ ê²°ì •
            const rect = this.getBoundingClientRect();
            const midpoint = rect.left + rect.width / 2;

            if (e.originalEvent.clientX < midpoint) {
                // ì™¼ìª½ì— ë“œë¡­ - íƒ€ê²Ÿ ì•ì— ì‚½ì…
                targetItem.before(draggingItem);
            } else {
                // ì˜¤ë¥¸ìª½ì— ë“œë¡­ - íƒ€ê²Ÿ ë’¤ì— ì‚½ì…
                targetItem.after(draggingItem);
            }

            // row ì†ì„± ì—…ë°ì´íŠ¸
            const newRow = targetRow.data('row');
            draggingItem.attr('data-row', newRow);

            // ì‹œê°ì  í”¼ë“œë°±
            $(this).addClass('drag-over-element');
        });

        $('.monitor-item').on('dragleave', function(e) {
            $(this).removeClass('drag-over-element');
        });

        $('.sortable-row').on('dragover', function(e) {
            e.preventDefault();
            $(this).addClass('drag-over');

            // ë¹ˆ rowì— ë“œë¡­í•  ë•Œ
            if ($(this).find('.monitor-item').length === 0) {
                if (draggedElement) {
                    $(this).append(draggedElement);
                    const dropRow = $(this).data('row');
                    $(draggedElement).attr('data-row', dropRow);
                }
            }
        });

        $('.sortable-row').on('dragleave', function(e) {
            if (!$(e.relatedTarget).closest('.sortable-row').is(this)) {
                $(this).removeClass('drag-over');
            }
        });

        $('.sortable-row').on('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).removeClass('drag-over');

            console.log('Item dropped in row:', $(this).data('row'));
        });
    }

    // ë“œë˜ê·¸ì•¤ë“œë¡­ ë¹„í™œì„±í™”
    function disableDragAndDrop() {
        console.log('Disabling drag and drop');
        $('.monitor-item').attr('draggable', false);
        $('.monitor-item').off('dragstart dragend');
        $('.sortable-row').off('dragover dragleave drop');
    }

    // ìˆ¨ê¸°ê¸°/ë³´ì´ê¸° ë²„íŠ¼ í´ë¦­
    $(document).on('click', '.btn-toggle-visibility', function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (!isLayoutMode) {
            showErrorToast('í¸ì§‘ ëª¨ë“œì—ì„œë§Œ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }

        const $monitor = $(this).closest('.monitor-item');
        const $button = $(this);

        if ($monitor.hasClass('hidden')) {
            $monitor.removeClass('hidden');
            $button.find('i').removeClass('fa-eye-slash').addClass('fa-eye');
            $button.attr('title', 'ìˆ¨ê¸°ê¸°');
            showSuccessToast('ëª¨ë‹ˆí„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.');
        } else {
            $monitor.addClass('hidden');
            $button.find('i').removeClass('fa-eye').addClass('fa-eye-slash');
            $button.attr('title', 'ë³´ì´ê¸°');
            showSuccessToast('ëª¨ë‹ˆí„°ê°€ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤.');
        }

        updateHiddenMonitorsList();
    });

    // ë ˆì´ì•„ì›ƒ ì €ì¥
    $(document).on('click', '#saveLayoutBtn', function() {
    console.log('Save layout clicked');
    if (!isLayoutMode) {
        showErrorToast('í¸ì§‘ ëª¨ë“œì—ì„œë§Œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }

    // ë¡œë”© ìƒíƒœ í‘œì‹œ
    const $btn = $(this);
    const originalHtml = $btn.html();
    $btn.html('<i class="fas fa-spinner fa-spin"></i> ì €ì¥ ì¤‘...');
    $btn.prop('disabled', true);

    // í˜„ì¬ ë ˆì´ì•„ì›ƒ ë°ì´í„° ìˆ˜ì§‘
    const layoutData = collectLayoutData();

    // ì„œë²„ì— ì €ì¥ ìš”ì²­
    saveLayoutToServer(layoutData)
        .then(response => {
            if (response.success) {
                showSuccessToast('ë ˆì´ì•„ì›ƒì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                showErrorToast('ì €ì¥ ì‹¤íŒ¨: ' + response.message);
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            showErrorToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
            $btn.html(originalHtml);
            $btn.prop('disabled', false);
        });
});

    function collectLayoutData() {
    const layoutData = [];

    $('.matrix-card').each(function() {
        const matrixId = $(this).data('matrix-id');
        const monitors = [];

        $(this).find('.monitor-item').each(function(index) {
            const $monitor = $(this);
            const position = parseInt($monitor.data('position'));
            const row = parseInt($monitor.data('row'));
            const col = parseInt($monitor.data('col'));
            const isVisible = !$monitor.hasClass('hidden');

            monitors.push({
                position: position,
                row: row,
                col: col,
                display_order: index,
                is_visible: isVisible
            });
        });

        layoutData.push({
            matrix_id: matrixId,
            monitors: monitors
        });
    });

    console.log('Collected layout data:', layoutData);
    return layoutData;
}

function saveLayoutToServer(layoutData) {
    return fetch('/api/save-layout/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')  // CSRF í† í° í•„ìš”
        },
        body: JSON.stringify({
            layout_data: layoutData
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    });
}

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    function loadSavedLayout() {
    $('.matrix-card').each(function() {
        const matrixId = $(this).data('matrix-id');
        const $matrixCard = $(this);

        fetch(`/api/get-layout/${matrixId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.layout_data && data.layout_data.length > 0) {
                    // ì €ì¥ëœ ë ˆì´ì•„ì›ƒì´ ìˆìœ¼ë©´ ì ìš©
                    applyLayoutData(matrixId, data.layout_data);
                } else {
                    // ì €ì¥ëœ ë ˆì´ì•„ì›ƒì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ì ìš©
                    console.log('No saved layout found for matrix:', matrixId, 'applying default layout');
                    resetToDefaultLayout($matrixCard);
                }
            })
            .catch(error => {
                console.log('Layout load error for matrix:', matrixId, error);
                // ì˜¤ë¥˜ ë°œìƒì‹œì—ë„ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ì ìš©
                resetToDefaultLayout($matrixCard);
            });
    });
}

function applyLayoutData(matrixId, layoutData) {
    const $matrixCard = $(`.matrix-card[data-matrix-id="${matrixId}"]`);

    layoutData.forEach(monitorData => {
        const $monitor = $matrixCard.find(`.monitor-item[data-position="${monitorData.position}"]`);

        if ($monitor.length > 0) {
            // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            $monitor.attr('data-row', monitorData.row);
            $monitor.attr('data-col', monitorData.col);

            // ê°€ì‹œì„± ì—…ë°ì´íŠ¸
            if (monitorData.is_visible) {
                $monitor.removeClass('hidden');
                $monitor.find('.btn-toggle-visibility i').removeClass('fa-eye-slash').addClass('fa-eye');
                $monitor.find('.btn-toggle-visibility').attr('title', 'ìˆ¨ê¸°ê¸°');
            } else {
                $monitor.addClass('hidden');
                $monitor.find('.btn-toggle-visibility i').removeClass('fa-eye').addClass('fa-eye-slash');
                $monitor.find('.btn-toggle-visibility').attr('title', 'ë³´ì´ê¸°');
            }
        }
    });

    // ìˆœì„œì— ë”°ë¼ ë‹¤ì‹œ ì •ë ¬
    reorganizeMonitors($matrixCard, layoutData);
}

function reorganizeMonitors($matrixCard, layoutData) {
    // í–‰ë³„ë¡œ ê·¸ë£¹í™”
    const row1Monitors = [];
    const row2Monitors = [];

    layoutData.forEach(monitorData => {
        const $monitor = $matrixCard.find(`.monitor-item[data-position="${monitorData.position}"]`);
        if ($monitor.length > 0) {
            if (monitorData.row === 1) {
                row1Monitors.push({ element: $monitor[0], order: monitorData.display_order });
            } else if (monitorData.row === 2) {
                row2Monitors.push({ element: $monitor[0], order: monitorData.display_order });
            }
        }
    });

    // ìˆœì„œëŒ€ë¡œ ì •ë ¬
    row1Monitors.sort((a, b) => a.order - b.order);
    row2Monitors.sort((a, b) => a.order - b.order);

    // DOMì— ìˆœì„œëŒ€ë¡œ ì¬ë°°ì¹˜
    const $row1 = $matrixCard.find('.sortable-row[data-row="1"]');
    const $row2 = $matrixCard.find('.sortable-row[data-row="2"]');

    $row1.empty();
    $row2.empty();

    row1Monitors.forEach(item => $row1.append(item.element));
    row2Monitors.forEach(item => $row2.append(item.element));
}



// 9. ê¸°ì¡´ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í•¨ìˆ˜ë“¤ì´ ì—†ë‹¤ë©´ ì¶”ê°€
function showSuccessToast(message) {
    // Bootstrap toastë‚˜ ë‹¤ë¥¸ ì•Œë¦¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©
    // ì„ì‹œë¡œ alert ì‚¬ìš© (ì‹¤ì œë¡œëŠ” ë” ë‚˜ì€ UI êµ¬í˜„ ê¶Œì¥)
    alert('ì„±ê³µ: ' + message);
}

function showErrorToast(message) {
    // Bootstrap toastë‚˜ ë‹¤ë¥¸ ì•Œë¦¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©
    // ì„ì‹œë¡œ alert ì‚¬ìš© (ì‹¤ì œë¡œëŠ” ë” ë‚˜ì€ UI êµ¬í˜„ ê¶Œì¥)
    alert('ì˜¤ë¥˜: ' + message);
}

function showEditingToast() {
    showSuccessToast('í¸ì§‘ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ëª¨ë‹ˆí„°ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ë¥¼ ë³€ê²½í•˜ì„¸ìš”.');
}



    // ë ˆì´ì•„ì›ƒ ë¦¬ì…‹
   $(document).on('click', '#resetLayoutBtn', function() {
    console.log('Reset layout clicked');

    if (!confirm('ëª¨ë“  ë ˆì´ì•„ì›ƒì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }

    // ë¡œë”© ìƒíƒœ í‘œì‹œ
    const $btn = $(this);
    const originalHtml = $btn.html();
    $btn.html('<i class="fas fa-spinner fa-spin"></i> ì´ˆê¸°í™” ì¤‘...');
    $btn.prop('disabled', true);

    // ëª¨ë“  ë§¤íŠ¸ë¦­ìŠ¤ì˜ ë ˆì´ì•„ì›ƒ ì´ˆê¸°í™”
    const matrixIds = [];
    $('.matrix-card').each(function() {
        const matrixId = $(this).data('matrix-id');
        if (matrixId) {
            matrixIds.push(matrixId);
        }
    });

    if (matrixIds.length === 0) {
        showErrorToast('ì´ˆê¸°í™”í•  ë§¤íŠ¸ë¦­ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
        $btn.html(originalHtml);
        $btn.prop('disabled', false);
        return;
    }

    // ì„œë²„ì— ì´ˆê¸°í™” ìš”ì²­
    resetLayoutOnServer(matrixIds)
        .then(response => {
            if (response.success) {
                // UIë¥¼ ê¸°ë³¸ ìƒíƒœë¡œ ë³µì›
                resetLayoutUI();
                showSuccessToast('ë ˆì´ì•„ì›ƒì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                showErrorToast('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + response.message);
            }
        })
        .catch(error => {
            console.error('Reset error:', error);
            showErrorToast('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
            $btn.html(originalHtml);
            $btn.prop('disabled', false);
        });
});

function resetLayoutOnServer(matrixIds) {
    return fetch('/api/reset-layout/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            matrix_ids: matrixIds
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    });
}

function resetLayoutUI() {
    console.log('Resetting layout UI to default state');

    $('.matrix-card').each(function() {
        const $matrixCard = $(this);
        const matrixId = $matrixCard.data('matrix-id');

        // ëª¨ë“  ëª¨ë‹ˆí„°ë¥¼ í‘œì‹œ ìƒíƒœë¡œ ë³€ê²½
        $matrixCard.find('.monitor-item').removeClass('hidden');
        $matrixCard.find('.btn-toggle-visibility i').removeClass('fa-eye-slash').addClass('fa-eye');
        $matrixCard.find('.btn-toggle-visibility').attr('title', 'ìˆ¨ê¸°ê¸°');

        // 16í¬íŠ¸ ê¸°ë³¸ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ì¬ì •ë ¬
        resetToDefaultLayout($matrixCard);
    });

    // ìˆ¨ê²¨ì§„ ëª¨ë‹ˆí„° ëª©ë¡ ì—…ë°ì´íŠ¸
    updateHiddenMonitorsList();

    console.log('Layout UI reset completed');
}

function resetToDefaultLayout($matrixCard) {
    const $row1 = $matrixCard.find('.sortable-row[data-row="1"]');
    const $row2 = $matrixCard.find('.sortable-row[data-row="2"]');

    // ê¸°ì¡´ ëª¨ë‹ˆí„° ìš”ì†Œë“¤ì„ ìˆ˜ì§‘
    const allMonitors = $matrixCard.find('.monitor-item').detach();

    // í¬ì§€ì…˜ ìˆœì„œëŒ€ë¡œ ì •ë ¬
    const sortedMonitors = allMonitors.toArray().sort((a, b) => {
        return parseInt($(a).data('position')) - parseInt($(b).data('position'));
    });

    // í–‰ ë¹„ìš°ê¸°
    $row1.empty();
    $row2.empty();

    // ê¸°ë³¸ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ì¬ë°°ì¹˜ (1-8: ì²« ë²ˆì§¸ í–‰, 9-16: ë‘ ë²ˆì§¸ í–‰)
    sortedMonitors.forEach((monitor, index) => {
        const $monitor = $(monitor);
        const position = parseInt($monitor.data('position'));

        if (position <= 8) {
            // ì²« ë²ˆì§¸ í–‰ (1-8)
            $monitor.attr('data-row', 1);
            $monitor.attr('data-col', position);
            $row1.append($monitor);
        } else {
            // ë‘ ë²ˆì§¸ í–‰ (9-16)
            $monitor.attr('data-row', 2);
            $monitor.attr('data-col', position - 8);
            $row2.append($monitor);
        }

        // ëª¨ë‹ˆí„°ë¥¼ í‘œì‹œ ìƒíƒœë¡œ ì„¤ì •
        $monitor.removeClass('hidden');
        $monitor.find('.btn-toggle-visibility i').removeClass('fa-eye-slash').addClass('fa-eye');
        $monitor.find('.btn-toggle-visibility').attr('title', 'ìˆ¨ê¸°ê¸°');
    });

    console.log('Default layout applied for matrix:', $matrixCard.data('matrix-id'));
}

    // ë ˆì´ì•„ì›ƒ í¸ì§‘ ë‹«ê¸°
    $(document).on('click', '#closeLayoutBtn', function() {
        console.log('Close layout clicked');
        exitLayoutMode();
        isLayoutMode = false;
    });

    // ìˆ¨ê²¨ì§„ ëª¨ë‹ˆí„° ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateHiddenMonitorsList() {
        const hiddenMonitors = [];

        $('.monitor-item.hidden').each(function() {
            const position = $(this).data('position');
            const matrixId = $(this).data('matrix');
            const name = $(this).find('.monitor-label').text() || `ëª¨ë‹ˆí„° ${position}`;

            hiddenMonitors.push({
                position: position,
                matrix_id: matrixId,
                name: name
            });
        });

        const $hiddenContainer = $('#hiddenMonitors');

        if (hiddenMonitors.length === 0) {
            $hiddenContainer.html('<small class="text-muted">ìˆ¨ê²¨ì§„ ëª¨ë‹ˆí„°ê°€ ì—†ìŠµë‹ˆë‹¤.</small>');
        } else {
            let html = '';
            hiddenMonitors.forEach(monitor => {
                html += `
                <div class="hidden-monitor-item mb-2 p-2 border rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">${monitor.name}</small>
                        <button class="btn btn-sm btn-outline-primary restore-monitor"
                                data-position="${monitor.position}"
                                data-matrix-id="${monitor.matrix_id}"
                                title="ë‹¤ì‹œ ë³´ì´ê¸°">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                `;
            });
            $hiddenContainer.html(html);
        }
    }

    // ìˆ¨ê²¨ì§„ ëª¨ë‹ˆí„° ë³µì›
    $(document).on('click', '.restore-monitor', function(e) {
        e.preventDefault();
        const position = $(this).data('position');
        const matrixId = $(this).data('matrix-id');

        const $monitor = $(`.monitor-item[data-position="${position}"][data-matrix="${matrixId}"]`);
        $monitor.removeClass('hidden');
        $monitor.find('.btn-toggle-visibility i').removeClass('fa-eye-slash').addClass('fa-eye');
        $monitor.find('.btn-toggle-visibility').attr('title', 'ìˆ¨ê¸°ê¸°');

        updateHiddenMonitorsList();
        showSuccessToast('ëª¨ë‹ˆí„°ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    // í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜ë“¤
    function showSuccessToast(message) {
        showToast(message, 'success');
    }

    function showErrorToast(message) {
        showToast(message, 'error');
    }

    function showToast(message, type) {
        const bgColor = type === 'success' ? '#28a745' : '#dc3545';

        $('.toast-notification').remove();

        const toast = $(`
        <div class="toast-notification" style="
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: ${bgColor};
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideInRight 0.3s ease;
        ">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            ${message}
        </div>
        `);

        $('body').append(toast);

        setTimeout(() => {
            toast.fadeOut(300, () => toast.remove());
        }, 3000);
    }

    function showEditingToast() {
        $('.editing-toast').remove();

        const toast = $(`
        <div class="editing-toast" style="
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-weight: 500;
            z-index: 9999;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            animation: slideDown 0.5s ease;
        ">
            <i class="fas fa-info-circle"></i>
            í¸ì§‘ ëª¨ë“œì…ë‹ˆë‹¤. ëª¨ë‹ˆí„°ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ ëˆˆ ë²„íŠ¼ìœ¼ë¡œ ìˆ¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤
        </div>
        `);

        $('body').append(toast);

        setTimeout(() => {
            toast.fadeOut(500, () => toast.remove());
        }, 3000);
    }

    $(document).on('click', '.btn-edit-names', function() {
    const position = $(this).data('position');
    const matrixId = $(this).data('matrix');

    // í˜„ì¬ ì´ë¦„ë“¤ ê°€ì ¸ì˜¤ê¸°
    const $monitorItem = $(`.monitor-item[data-position="${position}"][data-matrix="${matrixId}"]`);

    // ëª¨ë‹ˆí„° ì´ë¦„ - .monitor-labelì—ì„œ ê°€ì ¸ì˜¤ê¸° (ë©”ì¸ ë§¤íŠ¸ë¦­ìŠ¤ìš©)
    let currentMonitorName = $monitorItem.find('.monitor-label').text().trim();

    // ì„œë¸Œ ë§¤íŠ¸ë¦­ìŠ¤ì˜ ê²½ìš° KVM ë²„íŠ¼ì—ì„œ ëª¨ë‹ˆí„° ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    if (!currentMonitorName) {
        currentMonitorName = $monitorItem.find('button[name="kvm_button"]').text().trim();
    }

    // select ì˜µì…˜ì—ì„œ í˜„ì¬ ì„ íƒëœ ë””ë°”ì´ìŠ¤ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    const $select = $monitorItem.find('select[name="input_select"]');
    let currentDeviceName = $select.find('option:selected').text().trim();

    // ëª¨ë‹¬ í¼ ì„¤ì • - ê¸°ì¡´ ì´ë¦„ë“¤ì„ ì…ë ¥ì°½ì— ë¯¸ë¦¬ ì±„ì›Œë„£ê¸°
    $('#modal-position').val(position);
    $('#modal-matrix-id').val(matrixId);

    // value ì†ì„± ëŒ€ì‹  val() ë©”ì„œë“œ ì‚¬ìš©í•˜ì—¬ ì…ë ¥ì°½ì— ê¸°ì¡´ ê°’ ì„¤ì •
    $('#modal-monitor-name').val(currentMonitorName);
    $('#modal-device-name').val(currentDeviceName);

    // í¼ action URL ì„¤ì •
    const actionUrl = `/api/matrix/${matrixId}/update-names/`;
    $('#updateNamesForm').attr('action', actionUrl);
});

// í¼ ì œì¶œ í›„ ì´ë¦„ ì—…ë°ì´íŠ¸
$('#updateNamesForm').on('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const actionUrl = $(this).attr('action');

    $.ajax({
        url: actionUrl,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                // ì„±ê³µ ì‹œ í™”ë©´ ì—…ë°ì´íŠ¸
                const position = $('#modal-position').val();
                const matrixId = $('#modal-matrix-id').val();
                const monitorName = $('#modal-monitor-name').val();
                const deviceName = $('#modal-device-name').val();

                // ëª¨ë‹ˆí„° ë¼ë²¨ ì—…ë°ì´íŠ¸
                const $monitorItem = $(`.monitor-item[data-position="${position}"][data-matrix="${matrixId}"]`);
                $monitorItem.find('.monitor-label').text(monitorName);

                // KVM ë²„íŠ¼ í…ìŠ¤íŠ¸ë„ ì—…ë°ì´íŠ¸ (ì„œë¸Œ ë§¤íŠ¸ë¦­ìŠ¤ìš©)
                $monitorItem.find('button[name="kvm_button"]').text(monitorName);

                // ëª¨ë‹¬ ë‹«ê¸°
                $('#updateNamesModal').modal('hide');

                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                showSuccessToast('ì´ë¦„ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë³€ê²½ì‚¬í•­ ë°˜ì˜
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('ì˜¤ë¥˜: ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            alert('ì´ë¦„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
});

// ì„±ê³µ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í•¨ìˆ˜ (ê¸°ì¡´ì— ìˆë‹¤ë©´ ì‚¬ìš©, ì—†ë‹¤ë©´ ì¶”ê°€)
function showSuccessToast(message) {
    // ê°„ë‹¨í•œ ì•Œë¦¼ (í† ìŠ¤íŠ¸ê°€ êµ¬í˜„ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°)
    const toast = $(`
        <div class="toast-container position-fixed top-0 end-0 p-3">
            <div class="toast show" role="alert">
                <div class="toast-header">
                    <strong class="me-auto">ì•Œë¦¼</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        </div>
    `);

    $('body').append(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ë¹„ë””ì˜¤ì›”/ê·¸ë£¹ëŸ¬ë‹ í† ê¸€ ê¸°ëŠ¥ (í—¤ë” ë²„íŠ¼ìš©)
document.addEventListener("DOMContentLoaded", () => {
    loadSavedLayout();
    const toggleBtn = document.getElementById('toggleBtn');
    const toggleSection = document.getElementById('toggleSection');

    // pcSectionìœ¼ë¡œ ì‚¬ìš©í•  ìš”ì†Œë“¤ (ë§¤íŠ¸ë¦­ìŠ¤ ì¹´ë“œë“¤)
    const pcSections = document.querySelectorAll('.matrix-card');

    if (!toggleBtn || !toggleSection) {
        console.warn("í† ê¸€ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    // í† ê¸€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    toggleBtn.addEventListener('click', () => {
        const isVideoWallMode = toggleBtn.textContent.trim() === 'ë¹„ë””ì˜¤ì›”';

        if (isVideoWallMode) {
            // ë¹„ë””ì˜¤ì›” -> ê·¸ë£¹ëŸ¬ë‹ ëª¨ë“œë¡œ ì „í™˜
            pcSections.forEach(el => {
                el.style.display = 'none';
            });
            toggleSection.style.display = 'block';
            toggleBtn.textContent = 'ê·¸ë£¹ëŸ¬ë‹';

            // ì¦ê²¨ì°¾ê¸° ì°½ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ (ìˆ¨ê¸°ì§€ ì•ŠìŒ)

            // ë ˆì´ì•„ì›ƒ í¸ì§‘ ë²„íŠ¼ë„ ìˆ¨ê¸°ê¸°
            const layoutToggleBtn = document.getElementById('layoutToggleBtn');
            if (layoutToggleBtn) {
                layoutToggleBtn.style.display = 'none';
            }

            // í¸ì§‘ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë¹„í™œì„±í™”
            if (window.isLayoutMode) {
                exitLayoutMode();
                window.isLayoutMode = false;
            }

        } else {
            // ê·¸ë£¹ëŸ¬ë‹ -> ë¹„ë””ì˜¤ì›” ëª¨ë“œë¡œ ì „í™˜
            pcSections.forEach(el => {
                el.style.display = 'block';
            });
            toggleSection.style.display = 'none';
            toggleBtn.textContent = 'ë¹„ë””ì˜¤ì›”';

            // ë ˆì´ì•„ì›ƒ í¸ì§‘ ë²„íŠ¼ë„ ë‹¤ì‹œ ë³´ì´ê¸°
            const layoutToggleBtn = document.getElementById('layoutToggleBtn');
            if (layoutToggleBtn) {
                layoutToggleBtn.style.display = 'block';
            }
        }
    });

    // ì±„ë„ ë°•ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸
    document.addEventListener('click', (e) => {
        if (e.target.closest('.channel-box')) {
            const channelBox = e.target.closest('.channel-box');

            // ì„ íƒ í•´ì œ ë²„íŠ¼ í´ë¦­ì‹œì—ëŠ” í† ê¸€í•˜ì§€ ì•ŠìŒ
            if (e.target.classList.contains('unselect-btn')) {
                e.preventDefault();
                channelBox.classList.remove('selected');
                return;
            }

            channelBox.classList.toggle('selected');
        }
    });

    // ê·¸ë£¹ ë²„íŠ¼ ê¸°ëŠ¥
    document.getElementById('groupBtn')?.addEventListener('click', () => {
        const selectedChannels = document.querySelectorAll('.channel-box.selected');
        if (selectedChannels.length > 1) {
            // ì‹¤ì œ ê·¸ë£¹ ì„¤ì • ë¡œì§ ì—¬ê¸°ì— ì¶”ê°€ í•„ìš”
            alert(`${selectedChannels.length}ê°œ ì±„ë„ì´ ê·¸ë£¹ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);

            // ì„ íƒëœ ì±„ë„ë“¤ì„ ì‹œê°ì ìœ¼ë¡œ ì—°ê²° í‘œì‹œ
            selectedChannels.forEach(channel => {
                channel.style.borderColor = '#28a745';
                channel.style.backgroundColor = '#d4edda';
            });

        } else {
            alert('2ê°œ ì´ìƒì˜ ì±„ë„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }
    });

    // ì–¸ê·¸ë£¹ ë²„íŠ¼ ê¸°ëŠ¥
    document.getElementById('ungroupBtn')?.addEventListener('click', () => {
        const selectedChannels = document.querySelectorAll('.channel-box.selected');
        if (selectedChannels.length > 0) {
            // ì‹¤ì œ ì–¸ê·¸ë£¹ ë¡œì§ ì—¬ê¸°ì— ì¶”ê°€ í•„ìš”
            selectedChannels.forEach(channel => {
                channel.classList.remove('selected');
                channel.style.borderColor = '';
                channel.style.backgroundColor = '';
            });

            alert('ì„ íƒëœ ì±„ë„ë“¤ì˜ ê·¸ë£¹ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            alert('í•´ì œí•  ì±„ë„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }
    });

    // ì „ì²´ ì„ íƒ í•´ì œ (ESC í‚¤)
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.channel-box.selected').forEach(channel => {
                channel.classList.remove('selected');
            });
        }
    });
});

</script>
{% endblock javascript %}