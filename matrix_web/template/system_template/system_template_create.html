<div
        class="modal fade"
        id="matrixCreate"
        tabindex="-1"
        role="dialog"
        aria-labelledby="exampleModalCenterTitle"
        aria-hidden="true"
>
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-semibold" id="exampleModalCenterTitle">시스템 추가</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="matrixCreateForm" method="post" action="{% url 'matrix' %}">
                {% csrf_token %}
                <div class="modal-body pt-3">
                    <div class="text-end mb-3">
                        <button type="button" id="scan-ip-btn" class="btn btn-sm glass-btn" onclick="scanHardwareIPs()">
                            <i class="fas fa-search"></i> 하드웨어 IP 검색
                        </button>
                    </div>

                    <div class="form-group mb-3">
                        <label for="create-input-name">시스템명</label>
                        <input
                                type="text"
                                class="form-control"
                                id="create-input-name"
                                name="name"
                                placeholder="Enter name"
                                value="{{ form.name.value|default_if_none:'' }}"
                        />
                        <div id="create-name-feedback" class="invalid-feedback"></div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="create-input-matrix-ip">Matrix IP</label>
                        <div class="d-flex align-items-stretch ip-input-group">
                            <select id="matrix-ip-select" class="form-select ip-dropdown" onchange="onIPSelectChange('matrix-ip-select', 'create-input-matrix-ip')">
                                <option value="">직접 입력</option>
                            </select>
                            <input
                                    type="text"
                                    class="form-control ip-input"
                                    id="create-input-matrix-ip"
                                    name="matrix_ip_address"
                                    placeholder="192.168.1.100"
                                    value="{{ form.matrix_ip_address.value|default_if_none:'' }}"
                            />
                        </div>
                        <div id="create-matrix-ip-feedback" class="invalid-feedback"></div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="create-input-kvm-ip">KVM IP</label>
                        <div class="d-flex align-items-stretch ip-input-group">
                            <select id="kvm-ip-select" class="form-select ip-dropdown" onchange="onIPSelectChange('kvm-ip-select', 'create-input-kvm-ip')">
                                <option value="">직접 입력</option>
                            </select>
                            <input
                                    type="text"
                                    class="form-control ip-input"
                                    id="create-input-kvm-ip"
                                    name="kvm_ip_address"
                                    placeholder="192.168.1.101"
                                    value="{{ form.kvm_ip_address.value|default_if_none:'' }}"
                            />
                        </div>
                        <div id="create-kvm-ip-feedback" class="invalid-feedback"></div>
                    </div>

                    <div class="form-group">
                        <input
                                type="hidden"
                                id="create-input-kvm-ip2"
                                name="kvm_ip_address2"
                                value="{{ form.kvm_ip_address2.value|default_if_none:'' }}"
                        />
                        <div id="create-kvm-ip-feedback2" class="invalid-feedback"></div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="create-input-port">포트번호</label>
                        <input
                                type="number"
                                class="form-control"
                                id="create-input-port"
                                name="port"
                                value="10580"
                                readonly
                        />
                        <div id="create-port-feedback" class="invalid-feedback"></div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="create-input-main-connect">메인 연결 번호</label>
                        <select id="create-input-main-connect" class="form-control" name="main_connect">
                            <option id="create-option" selected>번호 선택</option>
                            {% for main_connect in main_connect_list %}
                                <option value="{{main_connect}}">{{main_connect}}</option>
                            {% endfor %}
                        </select>
                        <div id="create-input-main-connect-feedback" class="invalid-feedback">
                            연결 번호를 선택해주세요. 선택 가능한 번호가 없다면 연결 초과입니다.
                        </div>
                    </div>

                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="is_main" id="is-main-create-true" value="True" />
                        <label class="form-check-label" for="is-main-create-true">main</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input
                                class="form-check-input"
                                type="radio"
                                name="is_main"
                                id="is-main-create-false"
                                value="False"
                                checked
                        />
                        <label class="form-check-label" for="is-main-create-false">sub</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modal-secondary" data-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-modal-primary" onClick="matrixCreate()">생성</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    window.scanHardwareIPs = function() {
        const matrixSelect = document.getElementById('matrix-ip-select');
        const kvmSelect = document.getElementById('kvm-ip-select');
        const scanBtn = document.getElementById('scan-ip-btn');
        matrixSelect.innerHTML = '<option value="">스캔 중...</option>';
        kvmSelect.innerHTML = '<option value="">스캔 중...</option>';
        matrixSelect.disabled = true;
        kvmSelect.disabled = true;
        scanBtn.disabled = true;
        scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 검색 중...';

        fetch('/api/scan_kvm_devices/')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.devices && data.devices.length > 0) {
                    updateIPDropdowns(data.devices);
                    console.log(`${data.devices.length}개의 장비를 찾았습니다.`);
                } else {
                    matrixSelect.innerHTML = '<option value="">장비를 찾을 수 없습니다</option>';
                    kvmSelect.innerHTML = '<option value="">장비를 찾을 수 없습니다</option>';
                    console.log('하드웨어 장비를 찾을 수 없습니다.');
                }
            })
            .catch(error => {
                console.error('IP 스캔 오류:', error);
                matrixSelect.innerHTML = '<option value="">스캔 실패</option>';
                kvmSelect.innerHTML = '<option value="">스캔 실패</option>';
                alert('IP 스캔 중 오류가 발생했습니다.');
            })
            .finally(() => {
                // 상태 복구
                matrixSelect.disabled = false;
                kvmSelect.disabled = false;
                scanBtn.disabled = false;
                scanBtn.innerHTML = '<i class="fas fa-search"></i> 하드웨어 IP 검색';
            });
    };

    function updateIPDropdowns(devices) {
        const matrixSelect = document.getElementById('matrix-ip-select');
        const kvmSelect = document.getElementById('kvm-ip-select');

        let options = '<option value="">직접 입력</option>';
        devices.forEach(ip => {
            options += `<option value="${ip}">${ip}</option>`;
        });

        matrixSelect.innerHTML = options;
        kvmSelect.innerHTML = options;
    }

    window.onIPSelectChange = function(selectId, inputId) {
        const select = document.getElementById(selectId);
        const input = document.getElementById(inputId);

        if (select.value) {
            input.value = select.value.trim();
            input.readOnly = true;
            input.classList.add('bg-light');
            input.classList.remove('is-invalid');

            if (inputId === 'create-input-matrix-ip') {
                document.getElementById('create-matrix-ip-feedback').textContent = '';
            } else if (inputId === 'create-input-kvm-ip') {
                document.getElementById('create-kvm-ip-feedback').textContent = '';
            }
        } else {
            input.value = '';
            input.readOnly = false;
            input.classList.remove('bg-light');
            input.focus();
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        if (typeof jQuery !== 'undefined') {
            $('#matrixCreate').on('shown.bs.modal', function () {
            });

            $('#matrixCreate').on('hidden.bs.modal', function () {
                document.getElementById('matrix-ip-select').innerHTML = '<option value="">직접 입력</option>';
                document.getElementById('kvm-ip-select').innerHTML = '<option value="">직접 입력</option>';

                const matrixInput = document.getElementById('create-input-matrix-ip');
                const kvmInput = document.getElementById('create-input-kvm-ip');

                if (matrixInput) {
                    matrixInput.readOnly = false;
                    matrixInput.classList.remove('bg-light');
                }
                if (kvmInput) {
                    kvmInput.readOnly = false;
                    kvmInput.classList.remove('bg-light');
                }
            });
        } else {
            const matrixCreateModal = document.getElementById('matrixCreate');
            if (matrixCreateModal) {
                matrixCreateModal.addEventListener('shown.bs.modal', function () {
                });

                matrixCreateModal.addEventListener('hidden.bs.modal', function () {

                    document.getElementById('matrix-ip-select').innerHTML = '<option value="">직접 입력</option>';
                    document.getElementById('kvm-ip-select').innerHTML = '<option value="">직접 입력</option>';

                    const matrixInput = document.getElementById('create-input-matrix-ip');
                    const kvmInput = document.getElementById('create-input-kvm-ip');

                    if (matrixInput) {
                        matrixInput.readOnly = false;
                        matrixInput.classList.remove('bg-light');
                    }
                    if (kvmInput) {
                        kvmInput.readOnly = false;
                        kvmInput.classList.remove('bg-light');
                    }
                });
            }
        }
    });

</script>
